---
title-block: none
format:
    html:
        css: nf-core_style.css
        toc: true                               # table of contents
        toc-location: left                      # float the table of contents to the left of the main document content
        toc-depth: 4                            # header levels 1,2,3
        toc-image: nf-core-differentialabundance_logo_light.png
        theme: default
        number-sections: false                  # add section numbering to headers
        df-print: paged                         # tables are printed as an html table with support for pagination over rows and columns
        embed-resources: true
        self-contained: true
params:
    meta: NULL
    input_dir: ./
    artifact_dir: NULL
    cpus: 1
    paramset_name: NULL
    study_type: NULL
    study_name: NULL
    study_abundance_type: NULL
    report_title: NULL
    report_contributors: NULL
    report_author: NULL
    report_scree: NULL
    round_digits: NULL
    observations_type: NULL
    observations: NULL                                          # GSE156533.samplesheet.csv
    observations_id_col: NULL
    observations_name_col: NULL
    features: NULL
    features_type: NULL
    features_id_col: NULL
    features_metadata_cols: NULL
    exploratory_log2_assays: NULL
    raw_matrix: NULL                                    # e.g. 0_salmon.merged.gene_counts_length_scaled.tsv
    normalised_matrix: NULL
    variance_stabilised_matrix: NULL
    contrasts_file: null                                        # e.g. GSE156533.contrasts.yaml
    differential_table: file.csv
    exploratory_n_features: null
    exploratory_clustering_method: null
    exploratory_cor_method: null
    exploratory_whisker_distance: null
    exploratory_mad_threshold: null
    exploratory_main_variable: null
    exploratory_assay_names: NULL
    exploratory_final_assay: NULL
    exploratory_palette_name: NULL
    versions_file: null                                         # e.g 17_software_versions.yml
    logo: null
    css: null
    citations: null
    filtering_min_samples: 1
    filtering_min_abundance: 1
    filtering_min_proportion: NULL
    filtering_grouping_var: NULL
    differential_method: NULL
    differential_file_suffix: NULL
    differential_feature_id_column: NULL
    differential_feature_name_column: NULL
    differential_fc_column: NULL
    differential_pval_column: NULL
    differential_qval_column: NULL
    differential_min_fold_change: NULL
    differential_foldchanges_logged: NULL
    differential_max_pval: NULL
    differential_max_qval: NULL
    differential_palette_name: NULL
    deseq2_lfc_threshold: NULL
    deseq2_p_adjust_method: NULL
    deseq2_alpha: NULL
    functional_method: NULL
    gprofiler2_significant: NULL
    gprofiler2_max_qval: NULL
    gene_sets_files: NULL
    contrasts: NULL

---

<!-- Load libraries -->

```{r}
#| include: false
library(knitr)
library(yaml)
library(shinyngs)
library(plotly)
library(DT)
```

<!-- Define some functions -->

```{r}
#| include: false
round_dataframe_columns <- function(df, columns = NULL, digits = -1) {
    if (digits == -1) {
        return(df)                              # if -1, return df without rounding
    }

    df <- data.frame(df, check.names = FALSE)   # make data.frame from vector as otherwise, the format will get messed up
    if (is.null(columns)) {
        columns <- colnames(df)[(unlist(lapply(df, is.numeric), use.names=F))]    # extract only numeric columns for rounding
    }
    df[,columns] <- format(data.frame(df[, columns], check.names = FALSE), scientific=T, digits=params$round_digits)
    # Convert columns back to numeric

    for (c in columns) {
        df[[c]][grep("^ *NA$", df[[c]])] <- NA
        df[[c]] <- as.numeric(df[[c]])
    }
    df
}
```

```{r, warning=FALSE}
#| include: false
# Load the datatables js
datatable(NULL)
```

```{r, warning=FALSE}
#| include: false
#| warning: false
cat("input_dir:", params$input_dir, "\n")
cat("versions_file:", params$versions_file, "\n")

file_path <- file.path(params$input_dir, params$versions_file)
cat("Full path:", file_path, "\n")

if (!file.exists(file_path)) {
  stop("Versions file does not exist at: ", file_path)
}
versions <- unlist(yaml.load_file(file.path(params$input_dir, params$versions_file)), recursive = FALSE)
params_table <- data.frame(Parameter = names(unlist(params)), Value = unlist(params), row.names = NULL)

# We'll subset the params table for different report sections
make_params_table <- function(name, pattern = NULL, remove_pattern = FALSE){
    subparams <- params_table
    if (! is.null(pattern)){
        subparams <- subparams[grep(pattern, subparams$Parameter),]
    }
    if (remove_pattern){
        subparams$Parameter <- sub(pattern, '', subparams$Parameter)
    }

    if (nrow(subparams) > 10){
        dom <- 'tp'
    }else{
        dom <- 't'
    }

    print( htmltools::tagList(datatable(subparams, caption = paste("Parameters used for", name), rownames = FALSE, options = list(dom = dom)) ))
}

report_title <- paste0('Differential ',  params$features_type, ' abundance report', ifelse(is.null(params$report_title), '', paste0(': ', params$report_title)))
report_subtitle <- paste0(ifelse(is.null(params$report_author), '', paste0('By ', params$report_author, ', ')), '<br>differentialabundance workflow version', versions[["Workflow.nf-core/differentialabundance"]])

```
