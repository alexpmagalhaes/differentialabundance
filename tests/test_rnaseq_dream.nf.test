nextflow_pipeline {

    name "Test Workflow main.nf - DIFFERENTIALABUNDANCE (dream)"
    script "../main.nf"
    tag "rnaseq_dream"
    tag "pipeline"
    profile "test_rnaseq_dream,rnaseq_dream"

    test("Test rnaseq dream profile - with toolsheet") {

        when {
            params {
                outdir              = "$outputDir"
                paramset_name       = "dream_rnaseq"
                differential_method = null
                functional_method   = null

                config_profile_name        = 'RNA-seq profile with `VARIANCEPARTITION_DREAM`'
                config_profile_description = 'Settings for RNA-seq analysis with `VARIANCEPARTITION_DREAM`'


                // Input data
                input               = 'https://github.com/nf-core/test-datasets/raw/differentialabundance/modules_testdata/variancepartition_dream/metadata.tsv'
                matrix              = 'https://github.com/nf-core/test-datasets/raw/differentialabundance/modules_testdata/variancepartition_dream/counts.tsv'
                contrasts_yml       = 'https://github.com/nf-core/test-datasets/raw/differentialabundance/testdata/formula_contrasts/rnaseq_complex_contrast.yaml'

                // To do: replace this with a cut-down mouse GTF matching the matrix for testing
                gtf = 'https://ftp.ensembl.org/pub/release-81/gtf/mus_musculus/Mus_musculus.GRCm38.81.gtf.gz'

                // Observations
                observations_id_col   = 'sample'
                observations_name_col = 'sample'

                // Features
                features_type          = 'gene'
                features_id_col        = 'gene_id'
                features_name_col      = 'gene_name'
                features_metadata_cols = 'gene_id,gene_name,gene_biotype'

                // Differential options
                differential_feature_id_column   = "gene_id"
                differential_feature_name_column = "gene_name"
                differential_fc_column           = "logFC"

                // Apply a higher filter to check that the filtering works
                filtering_min_abundance = 10

                // Exploratory
                exploratory_assay_names   = "raw,normalised"
                exploratory_final_assay   = "normalised"
                exploratory_log2_assays   = 'raw,normalised'
                exploratory_main_variable = 'contrasts'

                // Report options
                report_contributors = 'Jane Doe\nDirector of Institute of Microbiology\nUniversity of Smallville;John Smith\nPhD student\nInstitute of Microbiology\nUniversity of Smallville'

                // Other
                round_digits = 3

                // Study
                study_type = 'rnaseq'
                study_abundance_type = 'counts'

                // Differential options
                // differential_method              = "dream" // set by paramsheet
                differential_file_suffix         = ".dream.results.tsv"
                differential_fc_column           = "logFC"
                differential_pval_column         = "P.Value"
                differential_qval_column         = "adj.P.Val"
                differential_feature_id_column   = "Geneid"
                differential_feature_name_column = "Geneid"
                }
        }

        then {
            // stable_name: All files + folders in ${params.outdir}/ with a stable name
            def stable_name = getAllFilesFromDir(params.outdir, relative: true, includeDir: true, ignore: ['pipeline_info/*.{html,json,txt}'])
            // stable_path: All files in ${params.outdir}/ with stable content
            def stable_path = getAllFilesFromDir(params.outdir, ignoreFile: 'tests/.nftignore')
            assertAll(
                { assert workflow.success},
                { assert snapshot(
                    // Number of successful tasks
                    workflow.trace.succeeded().size(),
                    // pipeline versions.yml file for multiqc from which Nextflow version is removed because we tests pipelines on multiple Nextflow versions
                    removeNextflowVersion("$outputDir/pipeline_info/collated_versions.yml"),
                    // All stable path name, with a relative path
                    stable_name,
                    // All files with stable contents
                    stable_path
                ).match() }
                )
        }
    }


/*
    test("Test rnaseq dream profile - complex contrast") {

        when {
            params {
                outdir        = "$outputDir"
                config_profile_name        = 'RNA-seq profile with `VARIANCEPARTITION_DREAM`'
                config_profile_description = 'Settings for RNA-seq analysis with `VARIANCEPARTITION_DREAM`'

                // Input data
                input               = 'https://github.com/nf-core/test-datasets/raw/differentialabundance/modules_testdata/variancepartition_dream/metadata.tsv'
                matrix              = 'https://github.com/nf-core/test-datasets/raw/differentialabundance/modules_testdata/variancepartition_dream/counts.tsv'
                contrasts_yml       = 'https://github.com/nf-core/test-datasets/raw/differentialabundance/testdata/formula_contrasts/rnaseq_complex_contrast.yaml'

                // To do: replace this with a cut-down mouse GTF matching the matrix for testing
                gtf = 'https://ftp.ensembl.org/pub/release-81/gtf/mus_musculus/Mus_musculus.GRCm38.81.gtf.gz'

                // Observations
                observations_id_col   = 'sample'
                observations_name_col = 'sample'

                // Features
                features_type          = 'gene'
                features_id_col        = 'gene_id'
                features_name_col      = 'gene_name'
                features_metadata_cols = 'gene_id,gene_name,gene_biotype'

                // Differential options
                differential_feature_id_column   = "gene_id"
                differential_feature_name_column = "gene_name"
                differential_fc_column           = "logFC"

                // Apply a higher filter to check that the filtering works
                filtering_min_abundance = 10

                // Exploratory
                exploratory_assay_names   = "raw,normalised"
                exploratory_final_assay   = "normalised"
                exploratory_log2_assays   = 'raw,normalised'
                exploratory_main_variable = 'contrasts'

                // Report options
                report_contributors = 'Jane Doe\nDirector of Institute of Microbiology\nUniversity of Smallville;John Smith\nPhD student\nInstitute of Microbiology\nUniversity of Smallville'

                // Other
                round_digits = 3

                // Study
                study_type = 'rnaseq'
                study_abundance_type = 'counts'

                // Differential options
                differential_method              = "dream"
                differential_file_suffix         = ".dream.results.tsv"
                differential_fc_column           = "logFC"
                differential_pval_column         = "P.Value"
                differential_qval_column         = "adj.P.Val"
                differential_feature_id_column   = "Geneid"
                differential_feature_name_column = "Geneid"

            }
        }

        then {
            // stable_name: All files + folders in ${params.outdir}/ with a stable name
            def stable_name = getAllFilesFromDir(params.outdir, relative: true, includeDir: true, ignore: ['pipeline_info/*.{html,json,txt}'])
            // stable_path: All files in ${params.outdir}/ with stable content
            def stable_path = getAllFilesFromDir(params.outdir, ignoreFile: 'tests/.nftignore')
            assertAll(
                { assert workflow.success},
                { assert snapshot(
                    // Number of successful tasks
                    workflow.trace.succeeded().size(),
                    // pipeline versions.yml file for multiqc from which Nextflow version is removed because we tests pipelines on multiple Nextflow versions
                    removeNextflowVersion("$outputDir/pipeline_info/collated_versions.yml"),
                    // All stable path name, with a relative path
                    stable_name,
                    // All files with stable contents
                    stable_path
                ).match() }
                )
        }
    }
*/

}
