nextflow_pipeline {

    name "Test Workflow main.nf - DIFFERENTIALABUNDANCE (maxquant)"
    script "../main.nf"
    tag "maxquant"
    tag "pipeline"
    profile "test_maxquant, maxquant"

    test("Test maxquant profile") {

        when {
            params {
                outdir                     = "$outputDir"
                study_name                 = 'PXD043349'
                config_profile_name        = 'MaxQuant test profile'
                config_profile_description = 'MaxQuant test dataset to check pipeline function'

                // Input data
                input         = 'https://raw.githubusercontent.com/nf-core/test-datasets/modules/data/proteomics/maxquant/MaxQuant_samplesheet.tsv'
                matrix        = 'https://raw.githubusercontent.com/nf-core/test-datasets/modules/data/proteomics/maxquant/MaxQuant_proteinGroups.txt'
                contrasts_yml = 'https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/differentialabundance/testdata/MaxQuant_contrasts.yaml'

                // Observations
                observations_id_col   = 'Experiment'
                observations_name_col = 'Name'

                // Exploratory
                exploratory_main_variable = 'Celltype'
                exploratory_n_features    = -1

                // Study
                study_type              = 'maxquant'
                study_abundance_type    = 'intensities'

                // Features
                features_id_col         = 'Majority protein IDs'
                features_name_col       = 'Majority protein IDs'
                features_metadata_cols  = 'Majority protein IDs'
                features_type           = 'protein'

                // Exploratory
                exploratory_assay_names = "raw,normalised"
                exploratory_final_assay = "normalised"
                exploratory_log2_assays = null

                // Differential options
                differential_method              = "limma"
                differential_file_suffix         = ".limma.results.tsv"
                differential_fc_column           = "logFC"
                differential_pval_column         = "P.Value"
                differential_qval_column         = "adj.P.Val"
                differential_feature_id_column   = "Majority protein IDs"
                differential_feature_name_column = "Majority protein IDs"

                // Proteus options
                proteus_measurecol_prefix = 'LFQ intensity'

                // Shiny does not work for this datatype
                shinyngs_build_app               = false


                }
            }

        then {
            // stable_name: All files + folders in ${params.outdir}/ with a stable name
            def stable_name = getAllFilesFromDir(params.outdir, relative: true, includeDir: true, ignore: ['pipeline_info/*.{html,json,txt}'])
            // stable_path: All files in ${params.outdir}/ with stable content
            def stable_path = getAllFilesFromDir(params.outdir, ignoreFile: 'tests/.nftignore')
            assertAll(
                { assert workflow.success},
                { assert snapshot(
                    // Number of successful tasks
                    workflow.trace.succeeded().size(),
                    // pipeline versions.yml file for multiqc from which Nextflow version is removed because we tests pipelines on multiple Nextflow versions
                    removeNextflowVersion("$outputDir/pipeline_info/collated_versions.yml"),
                    // All stable path name, with a relative path
                    stable_name,
                    // All files with stable contents
                    stable_path
                ).match() }
                )
        }
    }

    test("Test maxquant profile - with toolsheet") {

        when {
            params {
                outdir              = "$outputDir"
                paramset_name       = "limma_maxquant"
                differential_method = null

                study_name                 = 'PXD043349'
                config_profile_name        = 'MaxQuant test profile'
                config_profile_description = 'MaxQuant test dataset to check pipeline function'

                // Input data
                input         = 'https://raw.githubusercontent.com/nf-core/test-datasets/modules/data/proteomics/maxquant/MaxQuant_samplesheet.tsv'
                matrix        = 'https://raw.githubusercontent.com/nf-core/test-datasets/modules/data/proteomics/maxquant/MaxQuant_proteinGroups.txt'
                contrasts_yml = 'https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/differentialabundance/testdata/MaxQuant_contrasts.yaml'

                // Observations
                observations_id_col   = 'Experiment'
                observations_name_col = 'Name'

                // Exploratory
                exploratory_main_variable = 'Celltype'
                exploratory_n_features    = -1

                // Study
                study_type              = 'maxquant'
                study_abundance_type    = 'intensities'

                // Features
                features_id_col         = 'Majority protein IDs'
                features_name_col       = 'Majority protein IDs'
                features_metadata_cols  = 'Majority protein IDs'
                features_type           = 'protein'

                // Exploratory
                exploratory_assay_names = "raw,normalised"
                exploratory_final_assay = "normalised"
                exploratory_log2_assays = null

                // Differential options
                differential_file_suffix         = ".limma.results.tsv"
                differential_fc_column           = "logFC"
                differential_pval_column         = "P.Value"
                differential_qval_column         = "adj.P.Val"
                differential_feature_id_column   = "Majority protein IDs"
                differential_feature_name_column = "Majority protein IDs"

                // Proteus options
                proteus_measurecol_prefix = 'LFQ intensity'

                // Shiny does not work for this datatype
                shinyngs_build_app               = false
            }
        }

        then {
            // stable_name: All files + folders in ${params.outdir}/ with a stable name
            def stable_name = getAllFilesFromDir(params.outdir, relative: true, includeDir: true, ignore: ['pipeline_info/*.{html,json,txt}'])
            // stable_path: All files in ${params.outdir}/ with stable content
            def stable_path = getAllFilesFromDir(params.outdir, ignoreFile: 'tests/.nftignore')
            assertAll(
                { assert workflow.success},
                { assert snapshot(
                    // Number of successful tasks
                    workflow.trace.succeeded().size(),
                    // pipeline versions.yml file for multiqc from which Nextflow version is removed because we tests pipelines on multiple Nextflow versions
                    removeNextflowVersion("$outputDir/pipeline_info/collated_versions.yml"),
                    // All stable path name, with a relative path
                    stable_name,
                    // All files with stable contents
                    stable_path
                ).match() }
                )
        }
    }
}
