nextflow_pipeline {

    name "Test Workflow main.nf - DIFFERENTIALABUNDANCE (soft)"
    script "../main.nf"
    tag "soft"
    tag "pipeline"
    profile "test_soft,soft"


    test("Test soft profile") {



        when {
            params {
                outdir                     = "$outputDir"
                config_profile_name        = 'SOFT matrix track test profile'
                config_profile_description = 'Minimal settings for test of the SOFT matrix track'

                // Input data
                input         = 'https://raw.githubusercontent.com/nf-core/test-datasets/differentialabundance/testdata/GSE50790.csv'
                contrasts_yml = 'https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/differentialabundance/testdata/GSE50790_contrasts.yaml'
                querygse      = 'GSE50790'

                // Study
                study_type = 'geo_soft_file'
                study_abundance_type = 'intensities'

                // Observations
                observations_id_col = 'id'
                observations_name_col = 'id'


                // Features
                features_id_col = 'ID'
                features_metadata_cols = 'ID,ENTREZ_GENE_ID,Gene Symbol,Sequence Type'
                features_name_col = 'Gene Symbol'


                // Exploratory
                exploratory_assay_names = 'normalised'
                exploratory_final_assay = 'normalised'
                exploratory_log2_assays = null

                // Differential options
                differential_method              = "limma"
                differential_file_suffix         = ".limma.results.tsv"
                differential_fc_column           = "logFC"
                differential_pval_column         = "P.Value"
                differential_qval_column         = "adj.P.Val"
                differential_feature_id_column   = "ID"
                differential_feature_name_column = "Symbol"

            }
        }

        then {
            // stable_name: All files + folders in ${params.outdir}/ with a stable name
            def stable_name = getAllFilesFromDir(params.outdir, relative: true, includeDir: true, ignore: ['pipeline_info/*.{html,json,txt}'])
            // stable_path: All files in ${params.outdir}/ with stable content
            def stable_path = getAllFilesFromDir(params.outdir, ignoreFile: 'tests/.nftignore')
            assertAll(
                { assert workflow.success},
                { assert snapshot(
                    // Number of successful tasks
                    workflow.trace.succeeded().size(),
                    // pipeline versions.yml file for multiqc from which Nextflow version is removed because we tests pipelines on multiple Nextflow versions
                    removeNextflowVersion("$outputDir/pipeline_info/collated_versions.yml"),
                    // All stable path name, with a relative path
                    stable_name,
                    // All files with stable contents
                    stable_path
                ).match() }
                )
        }
    }

    test("Test soft profile - with toolsheet") {



        when {


            params {

                config_profile_name        = 'SOFT matrix track test profile'
                config_profile_description = 'Minimal settings for test of the SOFT matrix track'

                // Input
                input         = 'https://raw.githubusercontent.com/nf-core/test-datasets/differentialabundance/testdata/GSE50790.csv'
                contrasts_yml = 'https://raw.githubusercontent.com/nf-core/test-datasets/refs/heads/differentialabundance/testdata/GSE50790_contrasts.yaml'
                querygse      = 'GSE50790'

                outdir              = "$outputDir"
                paramset_name       = "limma_soft"

                study_abundance_type = 'intensities'

                // Observations
                observations_id_col = 'id'
                observations_name_col = 'id'


                // Features
                features_id_col = 'ID'
                features_metadata_cols = 'ID,ENTREZ_GENE_ID,Gene Symbol,Sequence Type'
                features_name_col = 'Gene Symbol'


                // Exploratory
                exploratory_assay_names = 'normalised'
                exploratory_final_assay = 'normalised'
                exploratory_log2_assays = null

                // Differential options
                // differential_method              = "limma" // This is set in the toolsheet ../assets/paramsheet.csv
                differential_file_suffix         = ".limma.results.tsv"
                differential_fc_column           = "logFC"
                differential_pval_column         = "P.Value"
                differential_qval_column         = "adj.P.Val"
                differential_feature_id_column   = "ID"
                differential_feature_name_column = "Symbol"

            }
        }

        then {
            // stable_name: All files + folders in ${params.outdir}/ with a stable name
            def stable_name = getAllFilesFromDir(params.outdir, relative: true, includeDir: true, ignore: ['pipeline_info/*.{html,json,txt}'])
            // stable_path: All files in ${params.outdir}/ with stable content
            def stable_path = getAllFilesFromDir(params.outdir, ignoreFile: 'tests/.nftignore')
            assertAll(
                { assert workflow.success},
                { assert snapshot(
                    // Number of successful tasks
                    workflow.trace.succeeded().size(),
                    // pipeline versions.yml file for multiqc from which Nextflow version is removed because we tests pipelines on multiple Nextflow versions
                    removeNextflowVersion("$outputDir/pipeline_info/collated_versions.yml"),
                    // All stable path name, with a relative path
                    stable_name,
                    // All files with stable contents
                    stable_path
                ).match() }
                )
        }
    }
}
